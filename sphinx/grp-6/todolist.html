<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Tutorial: Writing a Simple Extension &#8212; Magpie 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/my-styles.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="JavaScript" href="../../javascript/javascript.html" />
    <link rel="prev" title="External Sphinx Links" href="external-links.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Magpie</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../vim/index.html">Vim</a></li>
                <li><a href="../sphinx">Sphinx</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../git/notes.html">Git Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../film/film.html">Film</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vim/index.html">Vim Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../sphinx.html">Sphinx Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/javascript.html">JavaScript</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="tutorial-writing-a-simple-extension">
<h1>Tutorial: Writing a Simple Extension<a class="headerlink" href="#tutorial-writing-a-simple-extension" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="http://www.sphinx-doc.org/en/1.5.1/extdev/tutorial.html">http://www.sphinx-doc.org/en/1.5.1/extdev/tutorial.html</a></p>
<p>We want the extension to add the following to Sphinx:</p>
<ul class="simple">
<li>A “todo” directive, containing some content that is marked with “TODO”, and only shown in the output if a new config value is set. (Todo entries should not be in the output by default.)</li>
<li>A “todolist” directive that creates a list of all todo entries throughout the documentation.</li>
</ul>
<p>For that, we will need to add the following elements to Sphinx:</p>
<ul class="simple">
<li>New directives, called <code class="code docutils literal notranslate"><span class="pre">todo</span></code> and <code class="code docutils literal notranslate"><span class="pre">todolist</span></code>.</li>
<li>New document tree nodes to represent these directives, conventionally also called todo and todolist. (We wouldn’t need new nodes if the new directives only produced some content representable by existing nodes.)</li>
<li>A new config value <code class="code docutils literal notranslate"><span class="pre">todo_include_todos</span></code> (config value names should start with the extension name, in order to stay unique) that controls whether todo entries make it into the output.</li>
<li>New event handlers: one for the <a class="reference external" href="http://www.sphinx-doc.org/en/master/extdev/appapi.html#event-doctree-resolved">doctree-resolved event</a>, to replace the todo and todolist nodes, and one for <a class="reference external" href="http://www.sphinx-doc.org/en/master/extdev/appapi.html#event-env-purge-doc">env-purge-doc</a> (the reason for that will be covered later).</li>
</ul>
<div class="section" id="important-objects">
<h2>Important Objects<a class="headerlink" href="#important-objects" title="Permalink to this headline">¶</a></h2>
<p>Key APIs used to write extensions:</p>
<table border="1" class="docutils" id="id1">
<caption><span class="caption-number">Table 1 </span><span class="caption-text">Important Objects</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Object</th>
<th class="head">Definition</th>
<th class="head">APIs</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Application</td>
<td><p class="first">An instance of Sphinx. It controls high-level functionality, such as setup of extentions, event dispatching, and logging.</p>
<p class="last">To learn more, see <a class="reference external" href="http://www.sphinx-doc.org/en/master/extdev/appapi.html#sphinx.application.Sphinx">Application API</a></p>
</td>
<td><code class="code docutils literal notranslate"><span class="pre">env.app</span></code></td>
</tr>
<tr class="row-odd"><td>Environment</td>
<td><p class="first">An instance of <code class="code docutils literal notranslate"><span class="pre">BuildEnvironment</span></code>.  Parses the source documents, stores all metadata about the document collection and is serialized to disk after each build.</p>
<p>Its API provides methods to do with access to metadata, resolving references, etc. It can also be used by extensions to cache information that should persist for incremental rebuilds.</p>
<p class="last">To learn more, see <a class="reference external" href="http://www.sphinx-doc.org/en/master/extdev/envapi.html#sphinx.environment.BuildEnvironment">Build Environment API</a>.</p>
</td>
<td><code class="code docutils literal notranslate"><span class="pre">app.env</span></code>, <code class="code docutils literal notranslate"><span class="pre">builder.env</span></code></td>
</tr>
<tr class="row-even"><td>Builder</td>
<td><p class="first">An instance of a specific subclass of <code class="code docutils literal notranslate"><span class="pre">Builder</span></code>. Each builder class knows how to convert the parsed documents into an output format, or otherwise process them (e.g. check external links).</p>
<p class="last">To learn mores, see <a class="reference external" href="http://www.sphinx-doc.org/en/master/extdev/builderapi.html#sphinx.builders.Builder">Builder API</a>.</p>
</td>
<td><code class="code docutils literal notranslate"><span class="pre">app.builder</span></code></td>
</tr>
<tr class="row-odd"><td>Config</td>
<td><p class="first">An instance of <code class="code docutils literal notranslate"><span class="pre">Config</span></code>. The <code class="code docutils literal notranslate"><span class="pre">config</span></code> object makes the values of alll config values available as attributes.</p>
<p>To learn more, see <a class="reference external" href="http://www.sphinx-doc.org/en/master/extdev/appapi.html#sphinx.config.Config">Config Object</a>.</p>
<p class="last">It is exposed via the <code class="code docutils literal notranslate"><span class="pre">sphinx.application.Application.config</span></code> and <code class="code docutils literal notranslate"><span class="pre">sphinx.environment.Environment.config</span></code> attributes. For example, to get the value of language, use either <code class="code docutils literal notranslate"><span class="pre">app.config.language</span></code> or <code class="code docutils literal notranslate"><span class="pre">env.config.language</span></code>.</p>
</td>
<td><code class="code docutils literal notranslate"><span class="pre">app.config</span></code>, <code class="code docutils literal notranslate"><span class="pre">env.config</span></code></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="set-up-function">
<h2>Set Up Function<a class="headerlink" href="#set-up-function" title="Permalink to this headline">¶</a></h2>
<p>The new elements are added in the extension’s setup function. Let us create a new Python module called <code class="code docutils literal notranslate"><span class="pre">todo.py</span></code> and add the setup function:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-number">Listing 16 </span><span class="caption-text">todo.py</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>

<span class="c1"># Tells Sphinx to recognize the new config value `todo_include_todos`, whose default value is False. Indicates that HTML must be rebuilt</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;todo_include_todos&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>

<span class="c1"># Adds a new node class to the build system. It also can specify visitor functions for each supported output format.</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">todolist</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span>
             <span class="n">html</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">),</span>
             <span class="n">latex</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">),</span>
             <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">))</span>

<span class="c1"># Adds a new directive, given by name and class.</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">,</span> <span class="n">TodoDirective</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;todolist&#39;</span><span class="p">,</span> <span class="n">TodolistDirective</span><span class="p">)</span>

<span class="c1"># Adds an event handler to the event whose name is given by the first argument.</span>
<span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;doctree-resolved&#39;</span><span class="p">,</span> <span class="n">process_todo_nodes</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;env-purge-doc&#39;</span><span class="p">,</span> <span class="n">purge_todos</span><span class="p">)</span>

<span class="k">return</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1&#39;</span><span class="p">}</span>   <span class="c1"># identifies the version of our extension</span>
</pre></div>
</td></tr></table></div>
</div>
<p>The calls in this function refer to classes and functions not yet written. What the individual calls do is the following:</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">add_config_value()</span></code> lets Sphinx know that it should recognize the new config value <code class="code docutils literal notranslate"><span class="pre">todo_include_todos</span></code>, whose default value should be False (this also tells Sphinx that it is a boolean value). If the third argument was ‘html’, HTML documents would be full rebuild if the config value changed its value. This is needed for config values that influence reading (build phase 1).</li>
<li><code class="code docutils literal notranslate"><span class="pre">add_node()</span></code> adds a new node class to the build system. It also can specify visitor functions for each supported output format. These visitor functions are needed when the new nodes stay until phase 4 – since the todolist node is always replaced in phase 3, it doesn’t need any.</li>
</ul>
<p>We need to create the two node classes <code class="code docutils literal notranslate"><span class="pre">todo</span></code> and <code class="code docutils literal notranslate"><span class="pre">todolist</span></code> later.</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">add_directive()</span></code> adds a new directive, given by name and class. The handler functions are created later.</li>
<li>Finally, <code class="code docutils literal notranslate"><span class="pre">connect()</span></code> adds an event handler to the event whose name is given by the first argument. The event handler function is called with several arguments which are documented with the event.</li>
</ul>
</div>
<div class="section" id="node-classes">
<h2>Node Classes<a class="headerlink" href="#node-classes" title="Permalink to this headline">¶</a></h2>
<p>Node classes usually don’t have to do anything except inherit from the standard docutils classes defined in <code class="code docutils literal notranslate"><span class="pre">docutils.nodes</span></code>.</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">todo</span></code> inherits from Admonition because it should be handled like a note or warning.</li>
<li><code class="code docutils literal notranslate"><span class="pre">todolist</span></code> is just a general node.</li>
</ul>
<p>Can roles inherit from nodes? Are there role nodes?</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Many extensions will not have to create their own node classes and work fine with the nodes already provided by docutils and Sphinx.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-number">Listing 17 </span><span class="caption-text">Node Class Definitions in todo.py</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>

<span class="k">class</span> <span class="nc">todo</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">todolist</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">General</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">visit_todo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">visit_admonition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">depart_todo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">depart_admonition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="directive-classes">
<h2>Directive Classes<a class="headerlink" href="#directive-classes" title="Permalink to this headline">¶</a></h2>
<p>A directive class is a class deriving usually from <code class="code docutils literal notranslate"><span class="pre">docutils.parsers.rst.Directive</span></code>.</p>
<p>The directive interface is also covered in detail in the <a class="reference external" href="http://docutils.sourceforge.net/docs/ref/rst/directives.html">docutils documentation</a>; the important thing is that the class should have attributes that configure the allowed markup, and a run method that returns a list of nodes.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-number">Listing 18 </span><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">todolist</span></code> Directive Class Definitions in <code class="code docutils literal notranslate"><span class="pre">todo.py</span></code></span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span>

<span class="c1"># An instance of our todolist node class is created and returned. The todolist directive has</span>
<span class="c1"># neither content nor arguments that need to be handled.</span>
<span class="k">class</span> <span class="nc">TodolistDirective</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">todolist</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-number">Listing 19 </span><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">todo</span></code> Directive Class Definitions in <code class="code docutils literal notranslate"><span class="pre">todo.py</span></code></span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sphinx.locale</span> <span class="kn">import</span> <span class="n">_</span>

<span class="k">class</span> <span class="nc">TodoDirective</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>

    <span class="c1"># this enables content in the directive</span>
    <span class="n">has_content</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#  You can refer to the build environment instance using self.state.document.settings.env.</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To act as a link target (from the todolist), the todo directive needs to return a target node in addition to the todo node.</span>

<span class="sd">        The target ID (in HTML, this will be the anchor name) is generated by using env.new_serialno which returns a new unique integer on each call and therefore leads to unique target names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">targetid</span> <span class="o">=</span> <span class="s2">&quot;todo-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">new_serialno</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">)</span>

        <span class="c1"># The target node is instantiated without any text (the first two arguments).</span>
        <span class="n">targetnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">targetid</span><span class="p">])</span>

        <span class="n">todo_node</span> <span class="o">=</span> <span class="n">todo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
        <span class="n">todo_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todo&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todo&#39;</span><span class="p">))</span>

        <span class="c1"># On creating admonition node, the content body of the directive are parsed</span>
        <span class="c1"># using self.state.nested_parse. The first argument gives the content body,</span>
        <span class="c1"># and the second one gives content offset. The third argument gives the parent</span>
        <span class="c1">#node of parsed result, in our case the todo node.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">nested_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_offset</span><span class="p">,</span> <span class="n">todo_node</span><span class="p">)</span>

        <span class="c1"># The todo node is added to the environment. This is needed to be able to create a list</span>
        <span class="c1"># of all todo entries throughout the documentation, in the place where the author puts a</span>
        <span class="c1"># todolist directive.  The environment attribute todo_all_todos is used (again, the name</span>
        <span class="c1"># should be unique, so it is prefixed by the extension name). It does not exist when a new</span>
        <span class="c1"># environment is created, so the directive must check and create it if necessary.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
            <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Various information about the todo entry’s location are stored along with a copy of the node</span>
        <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;docname&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span>
            <span class="s1">&#39;lineno&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
            <span class="s1">&#39;todo&#39;</span><span class="p">:</span> <span class="n">todo_node</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">targetnode</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># The nodes that should be put into the doctree are returned: the target node and the</span>
        <span class="c1"># admonition node.</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">targetnode</span><span class="p">,</span> <span class="n">todo_node</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="event-handlers">
<h2>Event Handlers<a class="headerlink" href="#event-handlers" title="Permalink to this headline">¶</a></h2>
<p>Since we store information from source files in the environment, which is persistent, it may become out of date when the source file changes.</p>
<p>Therefore, before each source file is read, the environment’s records of it are cleared, and the <code class="code docutils literal notranslate"><span class="pre">env-purge-doc</span></code> event gives extensions a chance to do the same.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-number">Listing 20 </span><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">env-purge-doc</span></code> Event</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">purge_todos</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">docname</span><span class="p">):</span>

  <span class="c1"># We clear out all todos whose docname matches the given one from the :todo_all_todos list.</span>
  <span class="c1"># If there are todos left in the document, they will be added again during parsing.</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
      <span class="k">return</span>
  <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[</span><span class="n">todo</span> <span class="k">for</span> <span class="n">todo</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span>
                        <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">docname</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<p>The other handler belongs to the <code class="code docutils literal notranslate"><span class="pre">doctree-resolved</span></code> event. This event is emitted at the end of phase 3 and allows custom resolving to be done:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-number">Listing 21 </span><span class="caption-text"><code class="code docutils literal notranslate"><span class="pre">doctree-resolved</span></code> Event</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_todo_nodes</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">):</span>
    <span class="c1"># If config value is false, all todo and todolist nodes are removed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">todo_include_todos</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">todo</span><span class="p">):</span>
            <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="c1"># Replace all todolist nodes with a list of the collected todos.</span>
    <span class="c1"># Augment each todo with a backlink to the original location.</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">env</span>

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">todolist</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">todo_include_todos</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">([])</span>
            <span class="k">continue</span>

        <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Todolist nodes are replaced by a list of todo entries, complete with</span>
        <span class="c1"># backlinks to the location where they come from. List items are composed</span>
        <span class="c1"># of the nodes from the todo entry and docutils nodes created on the fly:</span>
        <span class="k">for</span> <span class="n">todo_info</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="p">:</span>

            <span class="c1"># a paragraph for each entry, containing text that gives the location</span>
            <span class="n">para</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;(The original entry is located in </span><span class="si">%s</span><span class="s1">, line </span><span class="si">%d</span><span class="s1"> and can be found &#39;</span><span class="p">)</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;lineno&#39;</span><span class="p">]))</span>
            <span class="n">para</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

            <span class="c1"># Create a link (reference node containing an italic node) with</span>
            <span class="c1"># the backreference</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">innernode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">emphasis</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">))</span>
            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refdocname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span>

            <span class="c1"># Reference URI is built depending on the builder and</span>
            <span class="c1"># appends the todo node&#39;s ID as an anchor name</span>
            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_relative_uri</span><span class="p">(</span>
                <span class="n">fromdocname</span><span class="p">,</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">])</span>
            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
            <span class="n">newnode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">innernode</span><span class="p">)</span>
            <span class="n">para</span> <span class="o">+=</span> <span class="n">newnode</span>
            <span class="n">para</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;.)&#39;</span><span class="p">,</span> <span class="s1">&#39;.)&#39;</span><span class="p">)</span>

            <span class="c1"># Insert into the todolist</span>
            <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;todo&#39;</span><span class="p">])</span>
            <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>

        <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="everything">
<h2>Everything<a class="headerlink" href="#everything" title="Permalink to this headline">¶</a></h2>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-number">Listing 22 </span><span class="caption-text">todo.py</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">Setup function</span>
<span class="sd">&quot;&quot;&quot;</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;todo_include_todos&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">todolist</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span>
             <span class="n">html</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">),</span>
             <span class="n">latex</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">),</span>
             <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">))</span>

<span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">,</span> <span class="n">TodoDirective</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;todolist&#39;</span><span class="p">,</span> <span class="n">TodolistDirective</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;doctree-resolved&#39;</span><span class="p">,</span> <span class="n">process_todo_nodes</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;env-purge-doc&#39;</span><span class="p">,</span> <span class="n">purge_todos</span><span class="p">)</span>

<span class="k">return</span> <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1&#39;</span><span class="p">}</span>   <span class="c1"># identifies the version of our extension</span>

<span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">Node classes</span>
<span class="sd">&quot;&quot;&quot;</span><span class="s2">&quot;</span>

<span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>

<span class="k">class</span> <span class="nc">todo</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
  <span class="k">pass</span>

<span class="k">class</span> <span class="nc">todolist</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">General</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
  <span class="k">pass</span>

<span class="k">def</span> <span class="nf">visit_todo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">visit_admonition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">depart_todo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">depart_admonition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">Directive classes</span>

<span class="sd">A directive class is a class deriving usually from docutils.parsers.rst.Directive. The directive interface is also covered in detail in the docutils documentation; the important thing is that the class should have attributes that configure the allowed markup, and a run method that returns a list of nodes.</span>
<span class="sd">&quot;&quot;&quot;</span><span class="s2">&quot;</span>


<span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">todolist node</span>
<span class="sd">&quot;&quot;&quot;</span><span class="s2">&quot;</span>

<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span>

<span class="k">class</span> <span class="nc">TodolistDirective</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">todolist</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>

<span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">todo node</span>
<span class="sd">&quot;&quot;&quot;</span><span class="s2">&quot;</span>

<span class="kn">from</span> <span class="nn">sphinx.util.compat</span> <span class="kn">import</span> <span class="n">make_admonition</span>
<span class="kn">from</span> <span class="nn">sphinx.locale</span> <span class="kn">import</span> <span class="n">_</span>

<span class="k">class</span> <span class="nc">TodoDirective</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>

    <span class="c1"># this enables content in the directive</span>
    <span class="n">has_content</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span>

        <span class="n">targetid</span> <span class="o">=</span> <span class="s2">&quot;todo-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">env</span><span class="o">.</span><span class="n">new_serialno</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">)</span>
        <span class="n">targetnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">targetid</span><span class="p">])</span>

        <span class="n">ad</span> <span class="o">=</span> <span class="n">make_admonition</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todo&#39;</span><span class="p">)],</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_offset</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">block_text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
            <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;docname&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span>
            <span class="s1">&#39;lineno&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
            <span class="s1">&#39;todo&#39;</span><span class="p">:</span> <span class="n">ad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">targetnode</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">targetnode</span><span class="p">]</span> <span class="o">+</span> <span class="n">ad</span>

<span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">Event handlers</span>
<span class="sd">&quot;&quot;&quot;</span><span class="s2">&quot;</span>

<span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">env-purge-doc event</span>
<span class="sd">&quot;&quot;&quot;</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">purge_todos</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">docname</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[</span><span class="n">todo</span> <span class="k">for</span> <span class="n">todo</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span>
                          <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">docname</span><span class="p">]</span>


<span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">doctree-resolved event</span>
<span class="sd">&quot;&quot;&quot;</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">process_todo_nodes</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">todo_include_todos</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">todo</span><span class="p">):</span>
          <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

  <span class="c1"># Replace all todolist nodes with a list of the collected todos.</span>
  <span class="c1"># Augment each todo with a backlink to the original location.</span>
  <span class="n">env</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">env</span>

  <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">todolist</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">todo_include_todos</span><span class="p">:</span>
          <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">([])</span>
          <span class="k">continue</span>

      <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>

      <span class="k">for</span> <span class="n">todo_info</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="p">:</span>
          <span class="n">para</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">()</span>
          <span class="n">filename</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
          <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
              <span class="n">_</span><span class="p">(</span><span class="s1">&#39;(The original entry is located in </span><span class="si">%s</span><span class="s1">, line </span><span class="si">%d</span><span class="s1"> and can be found &#39;</span><span class="p">)</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;lineno&#39;</span><span class="p">]))</span>
          <span class="n">para</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

          <span class="c1"># Create a reference</span>
          <span class="n">newnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
          <span class="n">innernode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">emphasis</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">))</span>
          <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refdocname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span>
          <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_relative_uri</span><span class="p">(</span>
              <span class="n">fromdocname</span><span class="p">,</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">])</span>
          <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
          <span class="n">newnode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">innernode</span><span class="p">)</span>
          <span class="n">para</span> <span class="o">+=</span> <span class="n">newnode</span>
          <span class="n">para</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;.)&#39;</span><span class="p">,</span> <span class="s1">&#39;.)&#39;</span><span class="p">)</span>

          <span class="c1"># Insert into the todolist</span>
          <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;todo&#39;</span><span class="p">])</span>
          <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>

      <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Customize theme based on the <a class="reference external" href="https://github.com/butcherpete/sphinx-template">Sphinx Bootstrap Theme</a>.</p>
</div>
<p>(The original entry is located in sphinx/grp-1/bootstrap.rst, line 102 and can be found <a class="reference external" href="../grp-1/bootstrap.html#todo-0"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Import docutils include files for special characters</p>
</div>
<p>(The original entry is located in sphinx/grp-1/themes.rst, line 119 and can be found <a class="reference external" href="../grp-1/themes.html#todo-0"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Fork sphinx-bootstrap-theme.</p>
</div>
<p>(The original entry is located in sphinx/grp-1/themes.rst, line 120 and can be found <a class="reference external" href="../grp-1/themes.html#todo-1"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Fork pyramid-sphinx-themes.</p>
</div>
<p>(The original entry is located in sphinx/grp-1/themes.rst, line 121 and can be found <a class="reference external" href="../grp-1/themes.html#todo-2"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Update using Bootstrap CSS.</p>
</div>
<p>(The original entry is located in sphinx/grp-1/themes.rst, line 122 and can be found <a class="reference external" href="../grp-1/themes.html#todo-3"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Rewrite Theme Templates.</p>
</div>
<p>(The original entry is located in sphinx/grp-1/themes.rst, line 123 and can be found <a class="reference external" href="../grp-1/themes.html#todo-4"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last"><a class="reference external" href="http://protips.readthedocs.io/link-roles.html">Creating Custom Link Roles</a></p>
</div>
<p>(The original entry is located in sphinx/grp-2/custom-role.rst, line 106 and can be found <a class="reference external" href="../grp-2/custom-role.html#todo-0"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Test gist <a class="reference external" href="https://gist.github.com/shimizukawa/3718712">https://gist.github.com/shimizukawa/3718712</a></p>
</div>
<p>(The original entry is located in sphinx/grp-2/custom-role.rst, line 107 and can be found <a class="reference external" href="../grp-2/custom-role.html#todo-1"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Create custom role that copies the existing <code class="code docutils literal notranslate"><span class="pre">term</span></code> role.</p>
</div>
<p>(The original entry is located in sphinx/grp-2/custom-role.rst, line 108 and can be found <a class="reference external" href="../grp-2/custom-role.html#todo-2"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Find out how to write custom HTML. The role changes how HTML is written.</p>
</div>
<p>(The original entry is located in sphinx/grp-2/custom-role.rst, line 109 and can be found <a class="reference external" href="../grp-2/custom-role.html#todo-3"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Do Sphinx tutorial: <a class="reference external" href="http://www.sphinx-doc.org/en/master/extdev/tutorial.html">Tutoral: Writing a Simple Extension</a>.</p>
</div>
<p>(The original entry is located in sphinx/grp-3/custom-directive.rst, line 106 and can be found <a class="reference external" href="../grp-3/custom-directive.html#todo-0"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Understand how a role specifies a new CSS class.</p>
</div>
<p>(The original entry is located in sphinx/grp-4/hover-boxes.rst, line 173 and can be found <a class="reference external" href="../grp-4/hover-boxes.html#todo-0"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Understand how a directive specifies a new CSS class. How do I enable the user to specify the class of a directive?</p>
</div>
<p>(The original entry is located in sphinx/grp-4/hover-boxes.rst, line 174 and can be found <a class="reference external" href="../grp-4/hover-boxes.html#todo-1"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Understand how a role is built. Many improvements can be made changing how Sphinx builds a directive/role in HTML and assigns CSS. For roles, the HTML is specified by the <code class="code docutils literal notranslate"><span class="pre">rawtext</span></code> parameter.</p>
</div>
<p>(The original entry is located in sphinx/grp-4/hover-boxes.rst, line 175 and can be found <a class="reference external" href="../grp-4/hover-boxes.html#todo-2"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Understand how/when substitutions occur. May effect custom role builds.</p>
</div>
<p>(The original entry is located in sphinx/grp-4/hover-boxes.rst, line 176 and can be found <a class="reference external" href="../grp-4/hover-boxes.html#todo-3"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Extend custom role to specify a unique CSS class.</p>
</div>
<p>(The original entry is located in sphinx/grp-4/hover-boxes.rst, line 177 and can be found <a class="reference external" href="../grp-4/hover-boxes.html#todo-4"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Extend custom role to use JavaScript (if possible).</p>
</div>
<p>(The original entry is located in sphinx/grp-4/hover-boxes.rst, line 178 and can be found <a class="reference external" href="../grp-4/hover-boxes.html#todo-5"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Learn to parse metadata</p>
</div>
<p>(The original entry is located in sphinx/grp-4/metadata.rst, line 105 and can be found <a class="reference external" href="../grp-4/metadata.html#todo-0"><em>here</em></a>.)</p>
<div class="admonition">
<p class="first admonition-title">Todo</p>
<p class="last">Learn to generate tags</p>
</div>
<p>(The original entry is located in sphinx/grp-4/metadata.rst, line 106 and can be found <a class="reference external" href="../grp-4/metadata.html#todo-1"><em>here</em></a>.)</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/sphinx/grp-6/todolist.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2018, Todd Smith.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>