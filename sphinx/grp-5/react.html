<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Adaptive Modern Product Documentation &#8212; Magpie 0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/my-styles.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="External Links" href="../grp-6/grp-6.html" />
    <link rel="prev" title="Sphinx &amp; React" href="grp-5.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          Magpie</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../vim/index.html">Vim</a></li>
                <li><a href="../sphinx">Sphinx</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../git/notes.html">Git Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../film/film.html">Film</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vim/index.html">Vim Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../sphinx.html">Sphinx Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../javascript/javascript.html">JavaScript</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="adaptive-modern-product-documentation">
<h1>Adaptive Modern Product Documentation<a class="headerlink" href="#adaptive-modern-product-documentation" title="Permalink to this headline">¶</a></h1>
<blockquote class="highlights">
<div><ul class="simple">
<li><a class="reference external" href="https://hackernoon.com/adaptive-modern-product-documentation-7d792fd8696d">https://hackernoon.com/adaptive-modern-product-documentation-7d792fd8696d</a></li>
<li><a class="reference external" href="https://gist.github.com/hishnash/933ce146289faf88dd633c249eb5f228">https://gist.github.com/hishnash/933ce146289faf88dd633c249eb5f228</a></li>
</ul>
</div></blockquote>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Combines Sphinx and React</li>
<li>Use custom directives</li>
<li>Builds pages dynamically based on the AST (abstract syntax tree): “Within our documentation, we have many cases where we have used custom directives to drive unique UI and logical components.”</li>
</ul>
</div>
<div class="section" id="custom-directives">
<h2>Custom Directives<a class="headerlink" href="#custom-directives" title="Permalink to this headline">¶</a></h2>
<p>“Sphinx refers to these nested objects as directives each one can take some options and child content.”</p>
<p>There the are four different custom directives in use:</p>
<ul class="simple">
<li><code class="code docutils literal notranslate"><span class="pre">tab</span></code></li>
<li><code class="code docutils literal notranslate"><span class="pre">dv</span></code> (dynamic value) this expects two child components that subclass our custom <code class="code docutils literal notranslate"><span class="pre">tab</span></code> directive.</li>
<li><code class="code docutils literal notranslate"><span class="pre">dvvis</span></code> is the directive that manages the visual tab (seen on the left below), this expects a figure.</li>
<li><code class="code docutils literal notranslate"><span class="pre">dvspec</span></code> is a more complex tab component that is rendered on the right below.</li>
</ul>
<p>“Within our documentation, we have many cases where we have used custom directives to drive unique UI and logical components.”</p>
<p>“Each such directive can take some custom config that is used to manages its rendering. As an example below is the source for our HMAC dynamic value.”</p>
<div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="p">..</span> <span class="ow">dv</span><span class="p">::</span> URL Encoding
    <span class="nc">:keywords:</span> <span class="nf">url-encoding</span>

<span class="p">    ..</span> <span class="ow">dvvis</span><span class="p">::</span> Visual

<span class="p">        ..</span> <span class="ow">figure</span><span class="p">::</span> /Images/encoding_crypto/URLEncodingDynamicValue.png

            A <span class="s">`Percent-encoding </span><span class="si">&lt;http://en.wikipedia.org/wiki/Percent-encoding&gt;</span><span class="s">`_</span> converter conforming to <span class="s">`RFC3986 </span><span class="si">&lt;http://tools.ietf.org/html/rfc3986&gt;</span><span class="s">`_</span>.

<span class="p">    ..</span> <span class="ow">dvspec</span><span class="p">::</span> Code
        <span class="nc">:identifier:</span> <span class="nf">com.luckymarmot.URLEncodingDynamicValue</span>

<span class="p">        ..</span> <span class="ow">arg</span><span class="p">::</span> input
            <span class="nc">:type:</span> <span class="nf">DynamicString</span>

            Text input to be encoded/decoded.

<span class="p">        ..</span> <span class="ow">arg</span><span class="p">::</span> charset
            <span class="nc">:type:</span> <span class="nf">string</span>
            <span class="nc">:default:</span> <span class="nf">``utf-8``</span>

            Charset to be used.

<span class="p">        ..</span> <span class="ow">arg</span><span class="p">::</span> mode
            <span class="nc">:type:</span> <span class="nf">number</span>
            <span class="nc">:default:</span> <span class="nf">``0`` (Encode)</span>

            Operation mode (0: Encode, 1: Decode).

<span class="p">        ..</span> <span class="ow">code-block</span><span class="p">::</span> <span class="k">javascript</span>

            <span class="kd">function</span> <span class="nx">evaluate</span><span class="p">(</span><span class="nx">context</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">dv</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DynamicValue</span><span class="p">(</span><span class="s1">&#39;com.luckymarmot.URLEncodingDynamicValue&#39;</span><span class="p">,</span> <span class="p">{</span>
                    <span class="s1">&#39;input&#39;</span><span class="o">:</span> <span class="s1">&#39;Something to be URL-encoded&#39;</span>
                <span class="p">});</span>
                <span class="k">return</span> <span class="nx">dv</span><span class="p">.</span><span class="nx">getEvaluatedString</span><span class="p">();</span>
            <span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="tabs-directive">
<h2>Tabs Directive<a class="headerlink" href="#tabs-directive" title="Permalink to this headline">¶</a></h2>
<p>Above we have looked at a few custom directives, but how do we set up these Sphinx extensions.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-number">Listing 15 </span><span class="caption-text">tab.py</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TabSection</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>
    <span class="n">has_content</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c1"># this directive can have children</span>
    <span class="n">required_arguments</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># has 1 arg</span>
    <span class="n">optional_arguments</span> <span class="o">=</span> <span class="mi">0</span>

     <span class="c1"># add a kwarg `keyworks` these are used for search</span>
    <span class="n">option_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">unchanged</span><span class="p">}</span>

    <span class="c1"># we need a new line after the args before the child content</span>
    <span class="n">final_argument_whitespace</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called when sphinx builds an AST out of the source files.</span>
<span class="sd">        Should return a list of nodes for the AST that will be appended in this location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keywords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># we need to create some things inside this AST</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">Element</span><span class="p">()</span>
        <span class="n">node</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span>

        <span class="c1"># build the AST for the child content</span>
        <span class="n">nested_parse_with_titles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="c1"># get the tab&#39;s title</span>
        <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># use the node we set up</span>
        <span class="c1"># (this is another class not shown here that subclasses Frame)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">TabFrameNode</span><span class="p">(</span>
          <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
          <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)],</span>
          <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">title</span><span class="p">],</span>
          <span class="n">index_keywords</span><span class="o">=</span><span class="n">keywords</span>
        <span class="p">)</span>
        <span class="n">frame</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">TabNode</span><span class="p">):</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">frame</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="react-ast">
<h2>React &amp; AST<a class="headerlink" href="#react-ast" title="Permalink to this headline">¶</a></h2>
<p>“To allow us to render these docs in React, we need to pass the AST that Sphinx uses before it renders this to a HTML page.</p>
<p>“This is done in a custom <a class="reference external" href="https://gist.github.com/hishnash/933ce146289faf88dd633c249eb5f228">build script</a>.</p>
<p>“The script produces a JSON dump of the AST for each file, these are uploaded to an Amazon S3 bucket and then served through AWS AWS CloudFront (a CDN service) to the client. As the user navigates the docs, the single page app pulls the needed JSON ASTs from CloudFront as and when needed.”</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is an example gist combining a few different source files from our build</span>
<span class="sd">script.</span>

<span class="sd">licensed to be under MIT</span>
<span class="sd">copywrite: Matthaus Woolard 2016 matthaus.woolard@gmail.com</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">docutils.nodes</span> <span class="kn">import</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span><span class="p">,</span> <span class="n">directives</span>
<span class="kn">from</span> <span class="nn">sphinx.builders.html</span> <span class="kn">import</span> <span class="n">StandaloneHTMLBuilder</span>
<span class="kn">from</span> <span class="nn">sphinx.util</span> <span class="kn">import</span> <span class="n">ensuredir</span><span class="p">,</span> <span class="n">copyfile</span>
<span class="kn">from</span> <span class="nn">sphinx.util.nodes</span> <span class="kn">import</span> <span class="n">inline_all_toctrees</span><span class="p">,</span> <span class="n">nested_parse_with_titles</span>
<span class="kn">from</span> <span class="nn">sphinx.util.console</span> <span class="kn">import</span> <span class="n">bold</span><span class="p">,</span> <span class="n">darkgreen</span><span class="p">,</span> <span class="n">brown</span>
<span class="kn">from</span> <span class="nn">algoliasearch</span> <span class="kn">import</span> <span class="n">algoliasearch</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="kn">from</span> <span class="nn">docutils.nodes</span> <span class="kn">import</span> <span class="n">title</span>
<span class="kn">from</span> <span class="nn">sectiontile.sectiontile</span> <span class="kn">import</span> <span class="n">SectionTileNode</span>

<span class="c1"># we need to do some image magic :)</span>
<span class="n">IMAGE_RX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;mainname&gt;[^@.]+)(?P&lt;res&gt;\@2x)?.(?P&lt;postfix&gt;[^\s]+)$&#39;</span><span class="p">)</span>

<span class="c1"># set this</span>
<span class="n">DOC_BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">algolia_to_index</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">class</span> <span class="nc">BreadcrumbContainerNode</span><span class="p">(</span><span class="n">SectionTileNode</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">visit_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">starttag</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;div&#39;</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">depart_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;/div&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BreadCrumbs</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>
    <span class="n">final_argument_whitespace</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">has_content</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">required_arguments</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">optional_arguments</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">option_spec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;icon&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">unchanged</span><span class="p">,</span>
        <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">unchanged</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keywords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">BreadcrumbContainerNode</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;icon&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="n">index_keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span>
        <span class="n">nested_parse_with_titles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="p">]</span>



<span class="k">def</span> <span class="nf">dict_children</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">docname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">no_index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">page_title</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">category</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the AST to a dict that is ready to upload and be used by React</span>

<span class="sd">    warning this is a reclusive function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">child_dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
        <span class="n">child_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="n">child</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">child</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">}</span>

        <span class="n">child_dict</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">],</span> <span class="n">_text</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">dict_children</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">,</span>
                                                          <span class="n">docname</span><span class="o">=</span><span class="n">docname</span><span class="p">,</span>
                                                          <span class="n">no_index</span><span class="o">=</span><span class="n">no_index</span><span class="p">,</span>
                                                          <span class="n">page_title</span><span class="o">=</span><span class="n">page_title</span><span class="p">,</span>
                                                          <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">_text</span>
        <span class="n">keywords</span> <span class="o">+=</span> <span class="n">kw</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">attributes</span>
            <span class="n">child_dict</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># a parent node will aggregate all the keywords of its children</span>
            <span class="c1"># these are used for searching.</span>
            <span class="n">keywords</span> <span class="o">+=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index_keywords&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indexed&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_index</span><span class="p">:</span>
                <span class="n">index</span><span class="p">(</span><span class="n">child_dict</span><span class="p">,</span> <span class="n">_text</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span>
                      <span class="n">kw</span> <span class="o">+</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index_keywords&#39;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">page_title</span><span class="p">,</span>
                      <span class="n">category</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
            <span class="c1"># We collect all text and merge into one long string for search</span>
            <span class="n">child_dict</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">child</span><span class="o">.</span><span class="n">astext</span><span class="p">()}</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">child</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>

        <span class="n">child_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_dict</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">child_dicts</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">keywords</span>


<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">child_dict</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">page_title</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Index a page item and push to Algolia search</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_dict</span> <span class="o">=</span> <span class="n">child_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">new_dict</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOC_VERSION&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">find_reference</span><span class="p">(</span><span class="n">child_dict</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">])</span>
    <span class="n">add_to_algolia_search</span><span class="p">({</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">child_dict</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">][</span><span class="s1">&#39;index_title&#39;</span><span class="p">],</span>
        <span class="s1">&#39;docname&#39;</span><span class="p">:</span> <span class="n">docname</span><span class="p">,</span>
        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">new_dict</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">child_dict</span><span class="p">[</span><span class="s1">&#39;attributes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;index_priority&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="s1">&#39;ref&#39;</span><span class="p">:</span> <span class="n">ref</span><span class="p">,</span>
        <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="n">keywords</span><span class="p">,</span>
        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
        <span class="s1">&#39;page_title&#39;</span><span class="p">:</span> <span class="n">page_title</span><span class="p">,</span>
        <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
        <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">DOC_BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/{docname}#{ref}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">docname</span><span class="o">=</span><span class="n">docname</span><span class="p">,</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">index_page</span><span class="p">(</span><span class="n">doc_tree</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Index a page, push it to algolia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">docname</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">find_title</span><span class="p">(</span><span class="n">doc_tree</span><span class="p">)</span>

    <span class="n">version</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOC_VERSION&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">add_to_algolia_search</span><span class="p">({</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
        <span class="s1">&#39;docname&#39;</span><span class="p">:</span> <span class="n">docname</span><span class="p">,</span>
        <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="s1">&#39;page&#39;</span><span class="p">},</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
        <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="n">keywords</span><span class="p">,</span>
        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
        <span class="s1">&#39;page_title&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
        <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
        <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">DOC_BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/{docname}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">docname</span><span class="o">=</span><span class="n">docname</span><span class="p">),</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">find_reference</span><span class="p">(</span><span class="n">attributes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    helper function to extract info for indexing creation of links</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">find_category</span><span class="p">(</span><span class="n">doctrees</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the Breadcrumbs on this pages AST</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">doctree</span> <span class="ow">in</span> <span class="n">doctrees</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">BreadcrumbContainerNode</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">Text</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">find_title</span><span class="p">(</span><span class="n">doctrees</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the page title</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">doctree</span> <span class="ow">in</span> <span class="n">doctrees</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dict_children</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">no_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">text</span>


<span class="k">def</span> <span class="nf">add_to_algolia_search</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add an item to be pushed to algolia</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">algolia_to_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">push_to_algolia_search</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOC_VERSION&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid DOC_VERSION NO INDEXING DONE&#39;</span><span class="p">)</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">algoliasearch</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ALGOLIA_KEY&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ALGOLIA_SECRET&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">init_index</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ALGOLIA_INDEX&#39;</span><span class="p">))</span>
    <span class="n">index</span><span class="o">.</span><span class="n">delete_by_query</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;facetFilters&#39;</span><span class="p">:</span> <span class="s1">&#39;version:{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOC_VERSION&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))})</span>
    <span class="n">index</span><span class="o">.</span><span class="n">add_objects</span><span class="p">(</span><span class="n">algolia_to_index</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">JsonHTMLBuilder</span><span class="p">(</span><span class="n">StandaloneHTMLBuilder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build both the html output but at the same time intercept the AST</span>

<span class="sd">    dump it to json and write the backup html for non javascript pages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;json-html-build&#39;</span>
    <span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;html&#39;</span>
    <span class="n">out_suffix</span> <span class="o">=</span> <span class="s1">&#39;.html&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We need to extract some images and build a map of these to replace</span>
<span class="sd">        the image names, we append the md5 of the image into the image name.</span>
<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_images</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">write_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">document</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        This method is called to write the AST to html it is called once per</span>
<span class="sd">        page.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">page_title</span> <span class="o">=</span> <span class="n">find_title</span><span class="p">(</span><span class="n">doctree</span><span class="p">)</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">find_category</span><span class="p">(</span><span class="n">doctree</span><span class="p">)</span>
        <span class="nb">dict</span><span class="p">,</span> <span class="n">page_text</span><span class="p">,</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">dict_children</span><span class="p">(</span><span class="n">doctree</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span>
                                                  <span class="n">page_title</span><span class="o">=</span><span class="n">page_title</span><span class="p">,</span>
                                                  <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
        <span class="n">index_page</span><span class="p">(</span><span class="n">doctree</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">page_text</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
        <span class="c1"># we also build a ast dump of the toc</span>
        <span class="n">toc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dict_children</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_toc_for</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="bp">self</span><span class="p">)],</span>
                                  <span class="n">docname</span><span class="p">,</span> <span class="n">no_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">toc_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">docname</span> <span class="o">+</span> <span class="s1">&#39;.toc.json&#39;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">docname</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># Guard against race condition</span>
                <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                    <span class="s1">&#39;toc&#39;</span><span class="p">:</span> <span class="n">toc</span>
                <span class="p">},</span> <span class="n">fp</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">toc_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">toc</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_image_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We want to just update images if they change so users browser</span>
<span class="sd">        cache works well</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># copy image files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">:</span>
            <span class="c1"># evey image must have a 1x version</span>
            <span class="n">ensuredir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedir</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">_src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">status_iterator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">,</span>
                                                 <span class="s1">&#39;copying images... &#39;</span><span class="p">,</span>
                                                 <span class="n">brown</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">)):</span>
                <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">[</span><span class="n">_src</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span>
                             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedir</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;cannot copy image file </span><span class="si">%r</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">_src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span><span class="p">:</span>
                    <span class="n">src</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span><span class="p">[</span><span class="n">_src</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedir</span><span class="p">,</span>
                                              <span class="n">dest</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;cannot copy image file </span><span class="si">%r</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span> <span class="n">err</span><span class="p">))</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;image_mappings.json&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_map</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post_process_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pick the best candidate for all image URIs.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;candidates&#39;</span><span class="p">]:</span>
                <span class="c1"># don&#39;t rewrite nonlocal image URIs</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;candidates&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">imgtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported_image_types</span><span class="p">:</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;candidates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">imgtype</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">candidate</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;no matching candidate for image URI </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">],</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
                    <span class="k">continue</span>
                <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="c1"># non-existing URI; let it alone</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_images</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">candidate</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">file</span><span class="p">,</span> <span class="n">file_hashed</span><span class="p">,</span> <span class="n">file_2x</span><span class="p">,</span> <span class="n">file_2x_hashed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_name</span><span class="p">(</span>
                <span class="n">candidate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">candidate</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_hashed</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">candidate</span><span class="p">),</span>
                                <span class="nb">file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">file_hashed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_2x</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">candidate</span><span class="p">),</span>
                                    <span class="n">file_2x</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_2x</span><span class="p">,</span> <span class="n">file_2x_hashed</span><span class="p">)</span>

            <span class="n">uri</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">uri</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_map</span><span class="p">[</span><span class="n">uri</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">[</span><span class="n">uri</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">[</span><span class="n">uri</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">uri</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri_2x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span><span class="p">[</span><span class="n">uri</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">SectionTileNode</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">_candidate</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">_candidate</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">_candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">_candidate</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">candidate</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_images</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span>
            <span class="nb">file</span><span class="p">,</span> <span class="n">file_hashed</span><span class="p">,</span> <span class="n">file_2x</span><span class="p">,</span> <span class="n">file_2x_hashed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_name</span><span class="p">(</span>
                <span class="n">candidate</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_hashed</span>

            <span class="k">if</span> <span class="nb">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">candidate</span><span class="p">),</span> <span class="nb">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">file_hashed</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_2x</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">candidate</span><span class="p">),</span>
                                    <span class="n">file_2x</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span><span class="p">[</span><span class="n">candidate</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_2x</span><span class="p">,</span> <span class="n">file_2x_hashed</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_map</span><span class="p">[</span><span class="n">_candidate</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">[</span><span class="n">candidate</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">node</span><span class="p">[</span><span class="s1">&#39;icon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_1x</span><span class="p">[</span><span class="n">candidate</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s1">&#39;icon_2x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_2x</span><span class="p">[</span><span class="n">candidate</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_image_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">IMAGE_RX</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;BAD IMAGE NAME:&#39;</span><span class="p">,</span> <span class="n">image_path</span><span class="p">)</span>
        <span class="n">mainname</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;mainname&#39;</span><span class="p">)</span>
        <span class="n">postfix</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;postfix&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>

        <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;@2x&#39;</span><span class="p">:</span>
            <span class="n">hash_2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">mainname</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">mainname</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hash_2x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">mainname</span><span class="p">,</span> <span class="s1">&#39;@2x&#39;</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">mainname</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>

        <span class="n">file_2x_hashed</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">file_2x</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">file_hashed</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">hash_2x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">file_2x_hashed</span> <span class="o">=</span> <span class="s1">&#39;{}-{}-@2x.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainname</span><span class="p">,</span> <span class="n">hash_2x</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
            <span class="n">file_2x</span> <span class="o">=</span> <span class="s1">&#39;{}@2x.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainname</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">file_hashed</span> <span class="o">=</span> <span class="s1">&#39;{}-{}.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainname</span><span class="p">,</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="s1">&#39;{}.{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mainname</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">file</span><span class="p">,</span> <span class="n">file_hashed</span><span class="p">,</span> <span class="n">file_2x</span><span class="p">,</span> <span class="n">file_2x_hashed</span>

    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">mainname</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">postfix</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">mainname</span> <span class="o">+</span> <span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">postfix</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">FileNotFoundError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Cant fine {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOC_VERSION&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOC_DEPLOY&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">:</span>
                <span class="n">push_to_algolia_search</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_builder</span><span class="p">(</span><span class="n">JsonHTMLBuilder</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;bc&#39;</span><span class="p">,</span> <span class="n">BreadCrumbs</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">BreadcrumbContainerNode</span><span class="p">,</span>
                 <span class="n">html</span><span class="o">=</span><span class="p">(</span><span class="n">BreadcrumbContainerNode</span><span class="o">.</span><span class="n">visit_node</span><span class="p">,</span>
                       <span class="n">BreadcrumbContainerNode</span><span class="o">.</span><span class="n">depart_node</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../../_sources/sphinx/grp-5/react.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2018, Todd Smith.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>